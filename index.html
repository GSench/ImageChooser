<!DOCTYPE html>
<html>

<head>
    <title>Choose the Best Image!</title>
</head>

<body style="background-color:black; color: white;">
    <div id="header">
        <h1>Image A/B selector</h1>
        <p>Load images and choose the best one passing A/B testing.<br>You can add new images at any time, even during the test running.</p>
    </div>
    <div id="add_images_field">
        <input type="file" accept="image/*" id="file-input" multiple>
        <div id="target" style="width:300px; height:60px; text-align:center; background-color:#7b1fa2;">You can drag images here</div>
    </div>
    <div id="selector_container" style="width:100%">
        <img id="A">
        <img id="B">
    </div>
    <input type="button" onclick="skip()" value="Skip" style="width:100px; height:30px; position: absolute; bottom: 0; left: 0;"/>

    <script>
        //Viewhoders
        const fileInput = document.getElementById('file-input');
        const target = document.getElementById('target');
        const imageA = document.getElementById('A');
        const imageB = document.getElementById('B');
        const selectorContainer = document.getElementById('selector_container');
        const addingField = document.getElementById('add_images_field');
        const header = document.getElementById('header');

        // Listeners
        // Drop files button listener
        fileInput.addEventListener('change', (e) => onImagesAdd(e.target.files));

        // Drag&drop files area listener
        target.addEventListener('drop', (e) => {
            e.stopPropagation();
            e.preventDefault();
            onImagesAdd(e.dataTransfer.files);
        });
        target.addEventListener('dragover', (e) => {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        // On images click listeners
        imageA.addEventListener('click', function(e) {
            onImageClick(0);
        });
        imageB.addEventListener('click', function(e) {
            onImageClick(1);
        });

        //Layout setting
        //Portrait/Landscape
        const isHorisontal = window.innerHeight < window.innerWidth;
        if (isHorisontal) {
            selectorContainer.setAttribute('horizontal', '');
            selectorContainer.setAttribute('layout', '');
            imageA.setAttribute('class', 'childDiv left');
            imageB.setAttribute('class', 'childDiv right');
        } else {
            selectorContainer.setAttribute('vertical', '');
            selectorContainer.setAttribute('layout', '');
            //imageA.style.width="100%";
            //imageB.style.width="100%";
        }

        // Resizing images to fit the window
        imageA.onload = function() {
          console.log("ImageA loading, ist size: "+imageA.naturalWidth+"px x "+imageA.naturalHeight+"px");
          var WtoHA = imageA.naturalWidth/imageA.naturalHeight;
          var availableWidth = window.innerWidth;
          var availableHeight = window.innerHeight-130; //-addingField.height;
          console.log("availableWidth = "+availableWidth+" availableHeight = "+availableHeight);
          if(isHorisontal){
            var tmp=imageA.naturalWidth; // need to remember current image width as nuber
            if(imageA.naturalHeight>availableHeight){ // image is too high
              tmp = availableHeight;
              imageA.style.height=tmp+"px"; // changing height to fit window height
              imageA.style.width=(tmp*WtoHA)+"px"; // changing width proportionaly
              tmp=tmp*WtoHA; // update current image width as nuber
            }
            if(tmp>availableWidth/2){ // now it is too wide
              var tmp = availableWidth/2-50; //-50 margin
              imageA.style.width=tmp+"px"; // changing width to fit 1/2 window width
              imageA.style.height=(tmp/WtoHA)+"px"; // changing height proportionaly
            }
          } else {
            if(imageA.naturalHeight>availableHeight/2){ // image is to high
              var tmp = availableHeight/2;
              imageA.style.height=tmp+"px"; // changing height to fit 1/2 window height
              imageA.style.width=(tmp*WtoHA)+"px"; // changing width proportionaly
            }
          }
        }
        imageB.onload = function() {
          console.log("ImageB loading, ist size: "+imageB.naturalWidth+"px x "+imageB.naturalHeight+"px");
          var WtoHB = imageB.naturalWidth/imageB.naturalHeight;
          var availableWidth = window.innerWidth;
          var availableHeight = window.innerHeight-130; //-addingField.height;
          console.log("availableWidth = "+availableWidth+" availableHeight = "+availableHeight);
          if(isHorisontal){
            var tmp = imageB.naturalWidth; // need to remember current image width as nuber
            if(imageB.naturalHeight>availableHeight){ // image is too high
              var tmp = availableHeight;
              imageB.style.height=tmp+"px"; // changing height to fit window height
              imageB.style.width=(tmp*WtoHB)+"px"; // changing width proportionaly
              tmp=tmp*WtoHB; // update current image width as nuber
            }
            if(tmp>availableWidth/2){ // now it is too wide
              var tmp = availableWidth/2-50; //-50 margin
              imageB.style.width=tmp+"px"; // changing width to fit 1/2 window width
              imageB.style.height=(tmp/WtoHB)+"px"; // changing height proportionaly
            }
          } else {
            if(imageB.naturalHeight>availableHeight/2){ // image is to high
              var tmp = availableHeight/2;
              imageB.style.height=tmp+"px"; // changing height to fit 1/2 window height
              imageB.style.width=(tmp*WtoHB)+"px"; // changing width proportionaly
            }
          }
        }

    </script>


    <script>
        // API
        function showImageOn(ab, image){
          if(ab==0) imageA.src = URL.createObjectURL(image);
          if(ab==1) imageB.src = URL.createObjectURL(image);
        }
        function removeImageOn(ab){
          if(ab==0) imageA.src = "#";
          if(ab==1) imageB.src = "#";
        }
        function hideHeader(){
          header.style.display = 'none';
        }
        function showHeader(){
          header.style.display = 'block';
        }
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>

    <script>
        // Main

        var images = [];
        var count = 0;
        var isTestRunning = false;
        var currentAB = [-1, -1];

        function onImagesAdd(fileList){

          var newImages = Array.from(fileList);
          count+=newImages.length;
          images=images.concat(newImages);

          if(isTestRunning) return;

          if(count<2){
            alert("Add more pictures");
            return;
          }

          startTest();
        }

        function startTest(){
          hideHeader();
          isTestRunning=true;
          currentAB[0] = getNextRandomIndexExcept(-1);
          currentAB[1] = getNextRandomIndexExcept(currentAB[0]);
          showImageOn(0, images[currentAB[0]]);
          showImageOn(1, images[currentAB[1]]);
        }

        function onImageClick(ab){
          if(!isTestRunning) return;
          if(count<=2) isTestRunning=false;
          var notClicked=1-ab;
          images[currentAB[notClicked]]=null;
          count--;
          if(count==1){
            currentAB[notClicked]=-1;
            removeImageOn(notClicked);
            alert("Congratulations! You've chosen th best one!");
          } else {
            currentAB[notClicked]=getNextRandomIndexExcept(currentAB[ab]);
            showImageOn(notClicked, images[currentAB[notClicked]]);
          }
        }

        function skip(){
          startTest();
        }

        function getNextRandomIndexExcept(currentOne){
          var exceptCurrent = currentOne>=0 ? 1 : 0;
          rand = getRandomInt(1, count-exceptCurrent);
          for (var i = 0; rand != 0; i++)
              if (images[i] && i != currentOne) rand--;
          return i - 1;
        }

    </script>

</body>

</html>
